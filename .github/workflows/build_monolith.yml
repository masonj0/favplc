name: Build Windows Monolith EXE

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: build-monolith-windows
  cancel-in-progress: true

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 60   # Increased from 45: large --collect-all bundles
                          # (playwright, scrapling, curl_cffi) can push build
                          # past 40 min on cold cache.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'    # Must match codebase target (was 3.11)
          cache: 'pip'

      # ── Browser caches ────────────────────────────────────────────────────────
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\ms-playwright
          key: playwright-win-${{ hashFiles('requirements.txt') }}

      - name: Cache camoufox browser data
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\camoufox
          key: camoufox-win-${{ hashFiles('requirements.txt') }}

      # ── PyInstaller intermediate build cache ──────────────────────────────────
      - name: Cache PyInstaller build artifacts
        uses: actions/cache@v4
        with:
          path: build
          key: pyinstaller-build-${{ runner.os }}-${{ hashFiles('requirements.txt', 'build_monolith.py', 'fortuna.py', 'fortuna_analytics.py') }}
          restore-keys: |
            pyinstaller-build-${{ runner.os }}-

      # ── Dependencies ──────────────────────────────────────────────────────────
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install --prefer-binary pyinstaller

          # tzdata: CRITICAL Windows dependency.
          # zoneinfo falls back to tzdata on Windows (no built-in IANA DB).
          # Without this: ZoneInfoNotFoundError("America/New_York")
          python -m pip install --prefer-binary tzdata

      - name: Fetch browser assets
        run: |
          python -m browserforge update
          python -m playwright install --with-deps chromium
          python -m camoufox fetch

      # ── Build ─────────────────────────────────────────────────────────────────
      - name: Build EXE
        run: |
          python build_monolith.py
          if (!(Test-Path "dist/FortunaFaucetPortableApp.exe")) {
            Write-Error "Build failed: EXE not found at dist/FortunaFaucetPortableApp.exe"
            exit 1
          }

      # ── Artifact reporting ────────────────────────────────────────────────────
      - name: Report build results
        if: success()
        run: |
          $size   = (Get-Item "dist/FortunaFaucetPortableApp.exe").Length / 1MB
          $sha256 = (Get-FileHash "dist/FortunaFaucetPortableApp.exe" -Algorithm SHA256).Hash
          $built  = (Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")

          Write-Host "[PASS] Build successful: $([math]::Round($size, 1)) MB" -ForegroundColor Green
          Write-Host "SHA256: $sha256"

          @"
          ## ✅ Build Results

          | Field   | Value |
          |---------|-------|
          | **Status** | Success |
          | **Size** | $([math]::Round($size, 2)) MB |
          | **SHA256** | ``$sha256`` |
          | **Built** | $built |
          | **Commit** | ``${{ github.sha }}`` |
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      # ── Upload artifact ───────────────────────────────────────────────────────
      - name: Upload EXE artifact
        uses: actions/upload-artifact@v7
        with:
          name: FortunaMonolith-Windows-${{ github.sha }}
          path: dist/FortunaFaucetPortableApp.exe
          retention-days: 30
