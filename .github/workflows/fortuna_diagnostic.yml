name: "üèá Fortuna Diagnostic v4 ‚Äî USA Thoroughbred Pipeline"
on:
  workflow_dispatch:
    inputs:
      test_date:
        description: 'General results date (YYMMDD, default: yesterday ET)'
        required: false
        default: ''
        type: string
      usa_date:
        description: 'USA adapter date (YYMMDD, default: last Saturday ‚Äî peak US card)'
        required: false
        default: ''
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  usa-tb-diagnostic:
    runs-on: ubuntu-22.04
    timeout-minutes: 50
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Cache Playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium

      - name: Restore Master Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-v3-master-
          restore-keys: |
            fortuna-db-v3-master-

      - name: "üî¨ USA Thoroughbred Pipeline Diagnostic"
        env:
          PYTHONPATH: .
          TEST_DATE: "${{ github.event.inputs.test_date }}"
          USA_DATE: "${{ github.event.inputs.usa_date }}"
        run: python3 scripts/usa_tb_diagnostic.py

      - name: Save Master Database (Update Cache)
        uses: actions/cache/save@v4
        if: always()
        with:
          path: fortuna.db
          key: fortuna-db-v3-master-${{ github.run_id }}

      - name: Upload HTML Forensics
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: usa-tb-html-snapshots
          path: _diag_snapshots/
          retention-days: 5
          if-no-files-found: warn
