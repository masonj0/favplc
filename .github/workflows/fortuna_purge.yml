name: "ğŸ§¹ Purge Corrupted Data"

on:
  workflow_dispatch:
    inputs:
      execute:
        description: 'Actually purge (false = dry run)'
        required: true
        default: 'false'
        type: choice
        options: ['false', 'true']
      cutoff_date:
        description: 'Delete ALL tips before this date (YYYY-MM-DD, blank = use brunchtime today)'
        required: false
        default: ''
        type: string
      cutoff_time:
        description: 'Delete tips before this time on cutoff date (HH:MM in ET, default: 11:00)'
        required: false
        default: '11:00'
        type: string
      exclude_venues:
        description: 'Keep tips from these venues (comma-separated, e.g., Aqueduct,Turfway Park)'
        required: false
        default: ''
        type: string
      target_adapters:
        description: 'Only purge tips from these adapters (comma-separated, blank = all corrupted)'
        required: false
        default: 'RacingAndSportsResults,AtTheRacesResults,AtTheRacesGreyhoundResults'
        type: string

permissions:
  contents: read
  actions: write    # needed for cache deletion

jobs:
  purge:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update

      - name: Restore Master Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-v3-master-
          restore-keys: fortuna-db-v3-master-

      - name: Check DB exists
        run: |
          if [ ! -f fortuna.db ]; then
            echo "::error::fortuna.db not found after cache restore"
            exit 1
          fi
          ls -lh fortuna.db

      - name: Run Purge
        env:
          PYTHONPATH: .
          CUTOFF_DATE: ${{ inputs.cutoff_date }}
          CUTOFF_TIME: ${{ inputs.cutoff_time }}
          EXCLUDE_VENUES: ${{ inputs.exclude_venues }}
          TARGET_ADAPTERS: ${{ inputs.target_adapters }}
        run: |
          FLAGS=""
          if [ "${{ inputs.execute }}" = "true" ]; then
            FLAGS="$FLAGS --execute"
          fi

          # Pass date/time as env vars so script can compute "brunchtime today"
          python3 << 'PYEOF'
          import os, sys, sqlite3, re
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo

          EASTERN = ZoneInfo("America/New_York")

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # SETUP
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          execute = "--execute" in sys.argv
          cutoff_date = os.environ.get("CUTOFF_DATE", "").strip()
          cutoff_time = os.environ.get("CUTOFF_TIME", "11:00").strip()
          exclude_venues_raw = os.environ.get("EXCLUDE_VENUES", "").strip()
          target_adapters_raw = os.environ.get("TARGET_ADAPTERS", "").strip()

          exclude_venues = {v.strip() for v in exclude_venues_raw.split(",") if v.strip()}
          target_adapters = {a.strip() for a in target_adapters_raw.split(",") if a.strip()}

          # Compute brunchtime cutoff (today 11:00 AM ET, or user-specified)
          now_et = datetime.now(EASTERN)
          if cutoff_date:
              try:
                  cutoff_dt = datetime.strptime(f"{cutoff_date} {cutoff_time}", "%Y-%m-%d %H:%M")
                  cutoff_dt = cutoff_dt.replace(tzinfo=EASTERN)
              except ValueError:
                  print(f"âŒ Invalid cutoff_date format: {cutoff_date}")
                  sys.exit(1)
          else:
              # Default: today at cutoff_time
              cutoff_dt = now_et.replace(hour=int(cutoff_time.split(":")[0]),
                                         minute=int(cutoff_time.split(":")[1]),
                                         second=0, microsecond=0)

          cutoff_iso = cutoff_dt.isoformat()

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # CONNECT
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          conn = sqlite3.connect("fortuna.db")
          conn.row_factory = sqlite3.Row

          def get_size_kb():
              import os
              return os.path.getsize("fortuna.db") / 1024

          size_before = get_size_kb()

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # PRE-PURGE STATE
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          total = conn.execute("SELECT COUNT(*) FROM tips").fetchone()[0]
          audited = conn.execute("SELECT COUNT(*) FROM tips WHERE audit_completed=1").fetchone()[0]
          unaudited = total - audited
          harvest_count = conn.execute("SELECT COUNT(*) FROM harvest_logs").fetchone()[0] if \
              conn.execute("SELECT 1 FROM sqlite_master WHERE type='table' AND name='harvest_logs'").fetchone() else 0

          print(f"# ğŸ§¹ Fortuna Data Purge â€” {'ğŸ”´ EXECUTE' if execute else 'ğŸŸ¡ DRY RUN'}\n")
          print(f"**Database:** `fortuna.db` ({size_before:.1f} KB)")
          print(f"**Time:** {now_et.strftime('%Y-%m-%d %H:%M:%S %Z')}")
          print(f"**Cutoff:** {cutoff_dt.strftime('%Y-%m-%d %H:%M %Z')}\n")

          print(f"## ğŸ“Š Pre-Purge State\n")
          print(f"- **Total tips:** {total}")
          print(f"- **Audited:** {audited}")
          print(f"- **Unaudited:** {unaudited}")
          print(f"- **Harvest logs:** {harvest_count}\n")

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # IDENTIFY CORRUPTED DATA
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          print(f"## ğŸ” Purge Targets\n")

          # Build WHERE clause
          conditions = []
          params = []

          # 1. Time-based cutoff (everything before brunchtime)
          conditions.append("start_time < ?")
          params.append(cutoff_iso)
          print(f"### â° Time Filter\n")
          print(f"Deleting tips with `start_time < {cutoff_dt.strftime('%Y-%m-%d %H:%M %Z')}`\n")

          # 2. Adapter filter (if specified)
          if target_adapters:
              placeholders = ",".join("?" * len(target_adapters))
              conditions.append(f"source IN ({placeholders})")
              params.extend(target_adapters)
              print(f"### ğŸ¯ Adapter Filter\n")
              print(f"Only purging tips from: `{', '.join(sorted(target_adapters))}`\n")

          # 3. Venue exclusion (keep specified venues regardless of time)
          if exclude_venues:
              # Build exclusion: remove the time condition for these venues
              venue_placeholders = ",".join("?" * len(exclude_venues))
              # This is tricky â€” we want to delete old tips EXCEPT from these venues
              # Rewrite: (time_condition AND NOT venue_exclusion) OR (adapter_condition AND NOT venue_exclusion)
              # Simpler: just add AND venue NOT IN (...)
              conditions.append(f"venue NOT IN ({venue_placeholders})")
              params.extend(exclude_venues)
              print(f"### ğŸ›¡ï¸ Venue Protection\n")
              print(f"Keeping ALL tips from: `{', '.join(sorted(exclude_venues))}`\n")

          where_clause = " AND ".join(conditions)

          # Preview what will be deleted
          preview = conn.execute(f"""
              SELECT venue, COUNT(*) as cnt, source,
                     MIN(start_time) as first, MAX(start_time) as last
              FROM tips WHERE {where_clause}
              GROUP BY venue, source ORDER BY cnt DESC
          """, params).fetchall()

          to_delete = sum(row['cnt'] for row in preview)

          if to_delete == 0:
              print(f"âœ… **No tips match the purge criteria.**\n")
              conn.close()
              sys.exit(0)

          print(f"### ğŸ“‹ Tips to Delete: **{to_delete}/{total}** ({to_delete/total*100:.1f}%)\n")
          print(f"```")
          print(f"  {'VENUE':<30s} {'ADAPTER':<35s} CNT  FIRSTâ†’LAST")
          print(f"  {'â”€'*30} {'â”€'*35} {'â”€'*4} {'â”€'*20}")
          for row in preview:
              print(f"  {row['venue']:<30s} {row['source']:<35s} {row['cnt']:>3}  "
                    f"{(row['first'] or '')[:10]}â†’{(row['last'] or '')[:10]}")
          print(f"```\n")

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # RESET AUDITS (optional â€” only if we're deleting audited tips)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          audited_to_delete = conn.execute(f"""
              SELECT COUNT(*) FROM tips
              WHERE audit_completed=1 AND ({where_clause})
          """, params).fetchone()[0]

          if audited_to_delete > 0:
              print(f"### ğŸ”„ Audited Tips Affected: **{audited_to_delete}**\n")
              print(f"These will be **permanently deleted** (no reset option for old data).\n")

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # EXECUTE OR DRY RUN
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if execute:
              print(f"## ğŸ”§ Executing Purge\n")

              # Delete tips
              conn.execute(f"DELETE FROM tips WHERE {where_clause}", params)
              print(f"  ğŸ—‘ï¸  Deleted {to_delete} tips\n")

              # Delete zero-race harvest logs
              if harvest_count > 0:
                  deleted_harvests = conn.execute(
                      "DELETE FROM harvest_logs WHERE race_count = 0 OR race_count IS NULL"
                  ).rowcount
                  print(f"  ğŸ—‘ï¸  Deleted {deleted_harvests} harvest_logs with zero races\n")

              # VACUUM
              print(f"  ğŸ§¹ Running VACUUM...")
              conn.execute("VACUUM")
              conn.commit()

              size_after = get_size_kb()
              print(f"  ğŸ“¦ Database size: {size_before:.1f} KB â†’ {size_after:.1f} KB "
                    f"({size_before - size_after:+.1f} KB)\n")

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # POST-PURGE VERIFICATION
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              total_after = conn.execute("SELECT COUNT(*) FROM tips").fetchone()[0]
              audited_after = conn.execute("SELECT COUNT(*) FROM tips WHERE audit_completed=1").fetchone()[0]
              harvest_after = conn.execute("SELECT COUNT(*) FROM harvest_logs").fetchone()[0] if harvest_count else 0

              print(f"## âœ… Post-Purge Verification\n")
              print(f"- **Tips remaining:** {total_after} (was {total})")
              print(f"- **Audited:** {audited_after} (was {audited})")
              if harvest_count:
                  print(f"- **Harvest logs:** {harvest_after} (was {harvest_count})")
              print()

              if total_after == total - to_delete:
                  print(f"âœ… Deletion count matches expectation\n")
              else:
                  print(f"âš ï¸ Expected {total - to_delete} tips, got {total_after}\n")

              # Show what survived
              survivors = conn.execute("""
                  SELECT venue, discipline, COUNT(*) as cnt
                  FROM tips GROUP BY venue, discipline
                  ORDER BY cnt DESC LIMIT 20
              """).fetchall()

              if survivors:
                  print(f"### Surviving tips by venue\n```")
                  for row in survivors:
                      disc_label = (row['discipline'] or 'Unknown')[:11].ljust(11)
                      print(f"  {row['venue']:<30s} [{disc_label}] {row['cnt']:>3} tips")
                  print(f"```\n")

          else:
              print(f"## ğŸŸ¡ Dry Run Complete\n")
              print(f"**No changes made.** Re-run with `execute: true` to purge.\n")

          conn.close()

          # Write to GHA summary
          with open(os.environ.get("GITHUB_STEP_SUMMARY", "/dev/stdout"), "a") as f:
              pass  # Already printed to stdout, which GHA captures

          PYEOF

      - name: Save Cleaned Database
        if: inputs.execute == 'true'
        uses: actions/cache/save@v4
        with:
          path: fortuna.db
          key: fortuna-db-v3-master-${{ github.run_number }}

      - name: Clear Old Caches
        if: inputs.execute == 'true'
        run: |
          echo "## ğŸ—„ï¸ Clearing stale GHA caches" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Delete ALL old master caches (keep only the one we just saved)
          deleted=0
          gh cache list --json key -q ".[].key" | \
            grep "fortuna-db-v3-master-" | \
            grep -v "fortuna-db-v3-master-${{ github.run_number }}" | \
            while read -r key; do
              echo "  ğŸ—‘ï¸  Deleting cache: \`$key\`" >> "$GITHUB_STEP_SUMMARY"
              gh cache delete "$key" 2>/dev/null || true
              deleted=$((deleted + 1))
            done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Deleted **${deleted}** old cache(s)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Cache cleanup complete" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Cleaned DB
        if: inputs.execute == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-db-cleaned-${{ github.run_number }}
          path: fortuna.db
          retention-days: 7
