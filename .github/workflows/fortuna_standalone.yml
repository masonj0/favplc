name: List of Best Bets

on:
  push:
    branches: [main]
    paths-ignore: ["**.md", ".github/workflows/build_monolith.yml", "docs/**"]
  schedule:
    - cron: "5 5,11,17,23 * * *"   # Quarter fetch - 5 min after UTC quarter boundaries
    - cron: "*/15 0-5,10-23 * * *" # Scoring loop - every 15 min during racing hours
  workflow_dispatch:
    inputs:
      daypart:
        description: 'Specify daypart (auto/Q1/Q2/Q3/Q4)'
        required: false
        default: 'auto'
        type: choice
        options: [auto, Q1, Q2, Q3, Q4]
      mode:
        description: 'Execution mode (auto/quarter-fetch/score-now)'
        required: false
        default: 'auto'
        type: choice
        options: [auto, quarter-fetch, score-now]
      force_fetch:
        description: 'Force structural re-fetch'
        required: false
        default: false
        type: boolean
      days:
        description: 'Audit lookback days'
        required: false
        default: '4'
        type: string
      quality:
        description: 'Filter by adapter quality'
        required: false
        default: ''
        type: choice
        options: ['', solid, lousy]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  resolve-mode:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      mode: ${{ steps.decide.outputs.mode }}
      daypart: ${{ steps.decide.outputs.daypart }}
      daypart_tag: ${{ steps.decide.outputs.daypart_tag }}
    steps:
      - id: decide
        name: Detect Mode and Daypart
        run: |
          #!/bin/bash
          set -e

          # Manual override from workflow_dispatch
          MODE_INPUT="${{ inputs.mode || 'auto' }}"
          FORCE="${{ inputs.force_fetch || 'false' }}"

          # Detect daypart
          DAYPART_INPUT="${{ inputs.daypart || 'auto' }}"
          if [ "$DAYPART_INPUT" = "auto" ] || [ -z "$DAYPART_INPUT" ]; then
            HOUR=$(TZ=America/New_York date +%-H)
            QUARTER=$(( (HOUR / 6) + 1 ))
            DAYPART="Q${QUARTER}"
          else
            DAYPART="$DAYPART_INPUT"
          fi

          DATE_STR=$(TZ=America/New_York date +%y%m%d)
          DAYPART_TAG="${DAYPART}_${DATE_STR}"

          echo "daypart=${DAYPART}" >> "$GITHUB_OUTPUT"
          echo "daypart_tag=${DAYPART_TAG}" >> "$GITHUB_OUTPUT"

          # Determine mode
          if [ "$MODE_INPUT" != "auto" ]; then
            # Map choice to internal mode name
            if [ "$MODE_INPUT" = "quarter-fetch" ]; then
              echo "mode=quarter_fetch" >> "$GITHUB_OUTPUT"
            elif [ "$MODE_INPUT" = "score-now" ]; then
              echo "mode=scoring_loop" >> "$GITHUB_OUTPUT"
            else
              echo "mode=$MODE_INPUT" >> "$GITHUB_OUTPUT"
            fi
          elif [ "$FORCE" = "true" ]; then
            echo "mode=quarter_fetch" >> "$GITHUB_OUTPUT"
          else
            MINUTE=$(TZ=America/New_York date +%-M)
            HOUR=$(TZ=America/New_York date +%-H)
            # Quarter boundary = first 20 minutes of hours 0, 6, 12, 18 (Eastern Standard)
            # or 1, 7, 13, 19 (Eastern Daylight).
            if (( (HOUR % 6 == 0) || (HOUR % 6 == 1) )) && (( MINUTE < 20 )); then
              echo "mode=quarter_fetch" >> "$GITHUB_OUTPUT"
            else
              echo "mode=scoring_loop" >> "$GITHUB_OUTPUT"
            fi
          fi

  quarter-fetch:
    needs: resolve-mode
    if: needs.resolve-mode.outputs.mode == 'quarter_fetch'
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-py312-${{ hashFiles('requirements.txt') }}

      - name: Restore Master Database
        id: cache-db
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-v4-master-${{ github.run_number }}
          restore-keys: fortuna-db-v4-master-

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium

      - name: Initialize DB if needed
        if: steps.cache-db.outputs.cache-hit != 'true'
        run: python3 -c "import fortuna; import asyncio; asyncio.run(fortuna.FortunaDB().initialize())"

      - name: Run Quarter Fetch
        env:
          PYTHONPATH: .
        run: |
          QUALITY_FLAG=""
          if [ -n "${{ inputs.quality }}" ]; then
            QUALITY_FLAG="--quality ${{ inputs.quality }}"
          fi
          FORCE_FLAG=""
          if [ "${{ inputs.force_fetch }}" = "true" ]; then
            FORCE_FLAG="--force-fetch"
          fi
          python3 fortuna.py \
            --daypart ${{ needs.resolve-mode.outputs.daypart }} \
            --quarter-fetch \
            $QUALITY_FLAG \
            $FORCE_FLAG \
            --save "races_${{ needs.resolve-mode.outputs.daypart_tag }}.json"

      - name: Save Snapshot to Cache
        uses: actions/cache/save@v4
        with:
          path: snapshots/
          key: fortuna-snapshot-${{ needs.resolve-mode.outputs.daypart_tag }}

      - name: Prepare Artifact
        if: always()
        run: |
          cp fortuna.db "fortuna_${{ needs.resolve-mode.outputs.daypart_tag }}.db"
          mv discovery_harvest.json "discovery_harvest_${{ needs.resolve-mode.outputs.daypart_tag }}.json" 2>/dev/null || echo '{}' > "discovery_harvest_${{ needs.resolve-mode.outputs.daypart_tag }}.json"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: discovery-${{ needs.resolve-mode.outputs.daypart_tag }}
          path: |
            races_${{ needs.resolve-mode.outputs.daypart_tag }}.json
            fortuna_${{ needs.resolve-mode.outputs.daypart_tag }}.db
            discovery_harvest_${{ needs.resolve-mode.outputs.daypart_tag }}.json
          retention-days: 1

  scoring-loop:
    needs: resolve-mode
    if: needs.resolve-mode.outputs.mode == 'scoring_loop'
    runs-on: ubuntu-22.04
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: deps-${{ runner.os }}-py312-${{ hashFiles('requirements.txt') }}

      - name: Restore Master Database
        id: cache-db
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-v4-master-${{ github.run_number }}
          restore-keys: fortuna-db-v4-master-

      - name: Restore Snapshot from Cache
        id: cache-snapshot
        uses: actions/cache/restore@v4
        with:
          path: snapshots/
          key: fortuna-snapshot-${{ needs.resolve-mode.outputs.daypart_tag }}

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt

      - name: Run Scoring Now
        if: steps.cache-snapshot.outputs.cache-hit == 'true'
        env:
          PYTHONPATH: .
        run: |
          python3 fortuna.py \
            --daypart ${{ needs.resolve-mode.outputs.daypart }} \
            --score-now

      - name: Log Warning if No Snapshot
        if: steps.cache-snapshot.outputs.cache-hit != 'true'
        run: echo "::warning::No snapshot found for ${{ needs.resolve-mode.outputs.daypart_tag }}. Skipping scoring."

      - name: Prepare Artifact
        if: always()
        run: cp fortuna.db "fortuna_scoring_${{ github.run_number }}.db"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scoring-${{ needs.resolve-mode.outputs.daypart_tag }}-${{ github.run_number }}
          path: |
            summary_grid.txt
            goldmine_report.txt
            fortuna_scoring_${{ github.run_number }}.db
          retention-days: 1

  audit:
    needs: [resolve-mode, quarter-fetch]
    if: always() && needs.resolve-mode.outputs.mode == 'quarter_fetch'
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-py312-${{ hashFiles('requirements.txt') }}

      - name: Restore Master Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-v4-master-${{ github.run_number }}
          restore-keys: fortuna-db-v4-master-

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium

      - name: Download Discovery Artifact
        uses: actions/download-artifact@v4
        with:
          name: discovery-${{ needs.resolve-mode.outputs.daypart_tag }}

      - name: Run Results Audit
        timeout-minutes: 20
        env:
          PYTHONPATH: .
        run: python3 fortuna_analytics.py --days "${{ inputs.days || '4' }}"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-results
          path: |
            analytics_report.txt
            fortuna.db
          retention-days: 1

  conclude:
    needs: [resolve-mode, quarter-fetch, scoring-loop, audit]
    if: always()
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: deps-conclude-${{ runner.os }}-py312-${{ hashFiles('requirements.txt') }}

      - name: Download All Artifacts
        uses: actions/download-artifact@v4

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt

      - name: Consolidate Database
        run: |
          # Use the most recent/relevant DB
          if [ -f audit-results/fortuna.db ]; then
            cp audit-results/fortuna.db fortuna.db
          elif [ -f scoring-${{ needs.resolve-mode.outputs.daypart_tag }}-${{ github.run_number }}/fortuna_scoring_${{ github.run_number }}.db ]; then
            cp scoring-${{ needs.resolve-mode.outputs.daypart_tag }}-${{ github.run_number }}/fortuna_scoring_${{ github.run_number }}.db fortuna.db
          elif [ -f discovery-${{ needs.resolve-mode.outputs.daypart_tag }}/fortuna_${{ needs.resolve-mode.outputs.daypart_tag }}.db ]; then
            cp discovery-${{ needs.resolve-mode.outputs.daypart_tag }}/fortuna_${{ needs.resolve-mode.outputs.daypart_tag }}.db fortuna.db
          fi

      - name: Generate Workflow Metadata
        run: |
          cat > workflow_metadata.json <<EOF
          {
            "run_number": ${{ github.run_number }},
            "run_id": "${{ github.run_id }}",
            "workflow": "${{ github.workflow }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "mode": "${{ needs.resolve-mode.outputs.mode }}",
            "daypart": "${{ needs.resolve-mode.outputs.daypart }}",
            "timestamp": "$(TZ=America/New_York date +%y%m%dT%H:%M:%SZ)"
          }
          EOF

      - name: Score Approaching Races
        run: |
          # If we have raw races (from discovery or audit artifact), we can score now
          RAW_RACES=""
          if [ -f discovery-${{ needs.resolve-mode.outputs.daypart_tag }}/races_${{ needs.resolve-mode.outputs.daypart_tag }}.json ]; then
            RAW_RACES="discovery-${{ needs.resolve-mode.outputs.daypart_tag }}/races_${{ needs.resolve-mode.outputs.daypart_tag }}.json"
          elif [ -f audit-results/raw_races.json ]; then
            RAW_RACES="audit-results/raw_races.json"
          fi

          if [ -n "$RAW_RACES" ] && [ -s "$RAW_RACES" ] && python3 -c "import json; d=json.load(open('$RAW_RACES')); assert len(d)>0" 2>/dev/null; then
            python3 fortuna.py --daypart ${{ needs.resolve-mode.outputs.daypart }} --load "$RAW_RACES" --score-now
          else
            echo "::warning::No valid race data to score in conclude job"
          fi

      - name: Generate Job Summary
        if: always()
        run: python3 scripts/generate_gha_summary.py

      - name: Save Master Database
        if: always()
        uses: actions/cache/save@v4
        with:
          path: fortuna.db
          key: fortuna-db-v4-master-${{ github.run_number }}

      - name: Upload Final Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: best-bet-reports-${{ github.run_number }}
          path: |
            summary_grid.txt
            goldmine_report.txt
            analytics_report.txt
            fortuna.db
            workflow_metadata.json
          retention-days: 1
