name: List of Best Bets

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0,30 * * * *' # Every 30 minutes (on the hour and half-hour)
  workflow_dispatch:
    inputs:
      hours:
        description: 'Discovery window in hours'
        required: false
        default: '8'
        type: string
      days:
        description: 'Audit lookback days'
        required: false
        default: '2'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'workflow_dispatch' }}

jobs:
  fetch-usa:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium
      - name: Run USA Discovery
        env:
          PYTHONPATH: .
        run: python3 fortuna.py --region USA --save "races_usa.json" --hours ${{ github.event.inputs.hours || 8 }}
      - name: Prepare Artifact
        run: |
          cp fortuna.db fortuna_usa.db
          mv discovery_harvest.json discovery_harvest_usa.json
      - uses: actions/upload-artifact@v4
        with:
          name: results-usa
          path: |
            races_usa.json
            fortuna_usa.db
            discovery_harvest_usa.json

  fetch-int:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium
      - name: Run INT Discovery
        env:
          PYTHONPATH: .
        run: python3 fortuna.py --region INT --save "races_int.json" --hours ${{ github.event.inputs.hours || 8 }}
      - name: Prepare Artifact
        run: |
          cp fortuna.db fortuna_int.db
          mv discovery_harvest.json discovery_harvest_int.json
      - uses: actions/upload-artifact@v4
        with:
          name: results-int
          path: |
            races_int.json
            fortuna_int.db
            discovery_harvest_int.json

  fetch-global:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium
      - name: Run GLOBAL Discovery
        env:
          PYTHONPATH: .
        run: python3 fortuna.py --region GLOBAL --save "races_global.json" --hours ${{ github.event.inputs.hours || 8 }}
      - name: Prepare Artifact
        run: |
          cp fortuna.db fortuna_global.db
          mv discovery_harvest.json discovery_harvest_global.json
      - uses: actions/upload-artifact@v4
        with:
          name: results-global
          path: |
            races_global.json
            fortuna_global.db
            discovery_harvest_global.json

  audit-results:
    needs: [fetch-usa, fetch-int, fetch-global]
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Download Discovery Artifacts
        uses: actions/download-artifact@v4
      - name: Consolidate Discovery Data
        run: |
          set -e
          echo "Consolidating discovery artifacts into primary database..."
          cp results-usa/races_usa.json .
          cp results-usa/fortuna_usa.db .
          cp results-usa/discovery_harvest_usa.json .
          cp results-int/races_int.json .
          cp results-int/fortuna_int.db .
          cp results-int/discovery_harvest_int.json .
          cp results-global/races_global.json .
          cp results-global/fortuna_global.db .
          cp results-global/discovery_harvest_global.json .

          python3 scripts/consolidate_parallel_runs.py \
            --json-pattern "races_*.json" \
            --db-pattern "fortuna_*.db" \
            --output-json "raw_races.json" \
            --output-db "fortuna.db"
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium
      - name: Run Results Audit
        env:
          PYTHONPATH: .
        run: python3 fortuna_analytics.py --days ${{ github.event.inputs.days || 2 }}
      - name: Prepare Final Audit Artifact
        run: |
          mv results_harvest.json results_harvest_audit.json
      - uses: actions/upload-artifact@v4
        with:
          name: results-audit
          path: |
            analytics_report.txt
            fortuna.db
            raw_races.json
            results_harvest_audit.json
            discovery_harvest_usa.json
            discovery_harvest_int.json
            discovery_harvest_global.json

  conclude:
    needs: [audit-results]
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Download Audit Artifact
        uses: actions/download-artifact@v4
        with:
          name: results-audit
      - name: Install summary dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
      - name: Run Monitor Report
        run: python3 fortuna.py --load "raw_races.json" --monitor --once
      - name: Generate Job Summary
        if: always()
        run: python3 scripts/generate_gha_summary.py
      - name: Save Fortuna Database
        if: always()
        uses: actions/cache/save@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
      - name: Upload Final Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: best-bet-reports-${{ github.run_number }}
          path: |
            summary_grid.txt
            goldmine_report.txt
            analytics_report.txt
            race_data.json
            raw_races.json
            qualified_races.json
            fortuna.db
            prediction_history.jsonl
          retention-days: 30
