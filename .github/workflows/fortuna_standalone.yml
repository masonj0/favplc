name: List of Best Bets

on:
  push:
    branches:
      - main
      - jules210
      - jules214
  schedule:
    - cron: '0,30 * * * *' # Every 30 minutes (on the hour and half-hour)
  workflow_dispatch:
    inputs:
      hours:
        description: 'Discovery window in hours'
        required: false
        default: '8'
        type: string
      days:
        description: 'Audit lookback days'
        required: false
        default: '2'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'workflow_dispatch' }}

jobs:
  fetch-usa:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium
      - name: Run USA Discovery
        env:
          PYTHONPATH: .
        run: python3 fortuna.py --region USA --save "races_usa.json" --hours ${{ github.event.inputs.hours || 8 }}
      - name: Prepare Artifact
        run: |
          cp fortuna.db fortuna_usa.db
          mv discovery_harvest.json discovery_harvest_usa.json
      - uses: actions/upload-artifact@v4
        with:
          name: results-usa
          path: |
            races_usa.json
            fortuna_usa.db
            discovery_harvest_usa.json

  fetch-int:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium
      - name: Run INT Discovery
        env:
          PYTHONPATH: .
        run: python3 fortuna.py --region INT --save "races_int.json" --hours ${{ github.event.inputs.hours || 8 }}
      - name: Prepare Artifact
        run: |
          cp fortuna.db fortuna_int.db
          mv discovery_harvest.json discovery_harvest_int.json
      - uses: actions/upload-artifact@v4
        with:
          name: results-int
          path: |
            races_int.json
            fortuna_int.db
            discovery_harvest_int.json

  audit-results:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m browserforge update
          playwright install --with-deps chromium
      - name: Run Results Audit
        env:
          PYTHONPATH: .
        run: python3 fortuna_analytics.py --days ${{ github.event.inputs.days || 2 }}
      - name: Prepare Artifact
        run: |
          cp fortuna.db fortuna_results.db
          mv results_harvest.json results_harvest_audit.json
      - uses: actions/upload-artifact@v4
        with:
          name: results-audit
          path: |
            analytics_report.txt
            fortuna_results.db
            results_harvest_audit.json

  conclude:
    needs: [fetch-usa, fetch-int, audit-results]
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: deps-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      - name: Restore Fortuna Database
        uses: actions/cache/restore@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
          restore-keys: |
            fortuna-db-
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      - name: Consolidate Data
        run: |
          set -e

          # Validate artifacts were downloaded
          for artifact_dir in results-usa results-int results-audit; do
            if [ ! -d "$artifact_dir" ]; then
              echo "Error: Artifact directory $artifact_dir not found!"
              exit 1
            fi
          done

          echo "Copying artifacts..."
          cp results-usa/races_usa.json . || { echo "Failed to copy races_usa.json"; exit 1; }
          cp results-usa/fortuna_usa.db . || { echo "Failed to copy fortuna_usa.db"; exit 1; }
          cp results-usa/discovery_harvest_usa.json .
          cp results-int/races_int.json .
          cp results-int/fortuna_int.db .
          cp results-int/discovery_harvest_int.json .
          cp results-audit/fortuna_results.db .
          cp results-audit/analytics_report.txt .
          cp results-audit/results_harvest_audit.json .

          # Verify consolidation script exists
          if [ ! -f "scripts/consolidate_parallel_runs.py" ]; then
            echo "Error: scripts/consolidate_parallel_runs.py not found!"
            exit 1
          fi

          echo "Running consolidation..."
          python3 scripts/consolidate_parallel_runs.py \
            --json-pattern "races_*.json" \
            --db-pattern "fortuna_*.db" \
            --output-json "raw_races.json" \
            --output-db "fortuna.db"

          # Validate outputs were created
          if [ ! -f "raw_races.json" ] || [ ! -f "fortuna.db" ]; then
            echo "Error: Consolidation did not produce expected outputs!"
            exit 1
          fi
          echo "Consolidation complete!"
      - name: Install summary dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
      - name: Run Monitor Report
        run: python3 fortuna.py --load "raw_races.json" --monitor --once
      - name: Generate Job Summary
        if: always()
        run: python3 scripts/generate_gha_summary.py
      - name: Save Fortuna Database
        if: always()
        uses: actions/cache/save@v4
        with:
          path: fortuna.db
          key: fortuna-db-${{ github.run_number }}
      - name: Upload Final Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: best-bet-reports-${{ github.run_number }}
          path: |
            summary_grid.txt
            goldmine_report.txt
            analytics_report.txt
            race_data.json
            raw_races.json
            qualified_races.json
            fortuna.db
            prediction_history.jsonl
          retention-days: 30
